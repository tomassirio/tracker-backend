name: Helm Deploy to Kubernetes

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (dev, staging, production)'
        required: true
        type: string
      image-tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: false
        type: string
        default: 'wanderer'
    secrets:
      TWINGATE_SERVICE_KEY:
        description: 'Twingate service key for cluster access'
        required: true
      KUBECONFIG_CONTENT:
        description: 'Base64 encoded kubeconfig file'
        required: true
      DB_PASSWORD:
        description: 'Password for wanderer database user'
        required: true
      DB_AUTH_PASSWORD:
        description: 'Password for wanderer_auth database user'
        required: true
      POSTGRES_PASSWORD:
        description: 'PostgreSQL superuser password'
        required: true
      JWT_SECRET:
        description: 'JWT signing secret'
        required: true

env:
  ENV_SUFFIX: ${{ inputs.environment == 'dev' && '-dev' || '' }}
  CORS_ORIGINS: http://localhost:51538,http://localhost:3000

jobs:
  deploy-postgres:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Twingate
        uses: twingate/github-action@v1
        with:
          service-key: ${{ secrets.TWINGATE_SERVICE_KEY }}

      - name: Setup Kubernetes
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy PostgreSQL
        env:
          PVC_NAME: postgres${{ env.ENV_SUFFIX }}-pvc
          STATEFULSET_NAME: postgres${{ env.ENV_SUFFIX }}
        run: |
          # Handle PVC change if StatefulSet exists
          if kubectl get statefulset $STATEFULSET_NAME -n ${{ inputs.namespace }} &>/dev/null; then
            CURRENT_PVC=$(kubectl get statefulset $STATEFULSET_NAME -n ${{ inputs.namespace }} -o jsonpath='{.spec.template.spec.volumes[?(@.name=="postgres-storage")].persistentVolumeClaim.claimName}')
            if [ "$CURRENT_PVC" != "$PVC_NAME" ]; then
              echo "PVC changed, recreating StatefulSet..."
              kubectl delete statefulset $STATEFULSET_NAME -n ${{ inputs.namespace }} --cascade=orphan
              kubectl delete pod ${STATEFULSET_NAME}-0 -n ${{ inputs.namespace }} --force --grace-period=0 || true
            fi
          fi
          
          helm upgrade --install postgres ./commons/src/main/chart \
            --namespace ${{ inputs.namespace }} \
            --create-namespace \
            --set environment.name="${{ inputs.environment }}" \
            --set environment.suffix="${{ env.ENV_SUFFIX }}" \
            --set postgres.password="${{ secrets.POSTGRES_PASSWORD }}" \
            --set postgres.userPassword="${{ secrets.DB_PASSWORD }}" \
            --set postgres.authPassword="${{ secrets.DB_AUTH_PASSWORD }}" \
            --set persistence.existingClaim="$PVC_NAME" \
            --wait --timeout 5m
          
          echo "✓ PostgreSQL deployed successfully"

  deploy-services:
    needs: deploy-postgres
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      matrix:
        service: [tracker-auth, tracker-command, tracker-query]
        include:
          - service: tracker-auth
            port: 8083
            db: wanderer_auth_db
          - service: tracker-command
            port: 8081
            db: wanderer_db
          - service: tracker-query
            port: 8082
            db: wanderer_db
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Twingate
        uses: twingate/github-action@v1
        with:
          service-key: ${{ secrets.TWINGATE_SERVICE_KEY }}

      - name: Setup Kubernetes
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update Chart.yaml version
        run: |
          if [ "${{ inputs.environment }}" == "dev" ]; then
            VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          else
            VERSION="${{ inputs.image-tag }}"
          fi
          
          CHART_FILE="./${{ matrix.service }}/src/main/chart/Chart.yaml"
          if [ -f "$CHART_FILE" ]; then
            sed -i "s/^version: .*/version: $VERSION/" "$CHART_FILE"
            sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" "$CHART_FILE"
          fi

      - name: Deploy ${{ matrix.service }}
        env:
          DB_PASSWORD: ${{ matrix.service == 'tracker-auth' && secrets.DB_AUTH_PASSWORD || secrets.DB_PASSWORD }}
          DB_URL: jdbc:postgresql://postgres${{ env.ENV_SUFFIX }}:5432/${{ matrix.db }}
        run: |
          CORS_ORIGINS="${{ env.CORS_ORIGINS }}"
          if [ -n "${{ vars.PUBLIC_URL }}" ]; then
            CORS_ORIGINS="${{ vars.PUBLIC_URL }},$CORS_ORIGINS"
          fi
          # Escape commas for Helm --set
          CORS_ORIGINS_ESCAPED="${CORS_ORIGINS//,/\\,}"
          
          HELM_ARGS=(
            "upgrade" "--install" "${{ matrix.service }}" "./${{ matrix.service }}/src/main/chart"
            "--namespace" "${{ inputs.namespace }}"
            "--set" "environment.name=${{ inputs.environment }}"
            "--set" "environment.suffix=${{ env.ENV_SUFFIX }}"
            "--set" "service.port=${{ matrix.port }}"
            "--set" "image.tag=${{ inputs.image-tag }}"
            "--set" "application.jwt.secret=${{ secrets.JWT_SECRET }}"
            "--set" "application.database.password=$DB_PASSWORD"
            "--set" "application.database.url=$DB_URL"
            "--set" "application.cors.allowedOrigins=$CORS_ORIGINS_ESCAPED"
            "--set" "ingress.enabled=false"
          )
          
          if [ "${{ matrix.service }}" == "tracker-auth" ]; then
            HELM_ARGS+=(
              "--set" "application.trackerCommandUrl=http://tracker-command${{ env.ENV_SUFFIX }}:8081"
              "--set" "application.trackerQueryUrl=http://tracker-query${{ env.ENV_SUFFIX }}:8082"
            )
          fi
          
          helm "${HELM_ARGS[@]}" --wait --timeout 5m
          echo "✓ ${{ matrix.service }} deployed successfully"

      - name: Check pod health
        run: |
          kubectl wait --for=condition=ready pod -l app=${{ matrix.service }}${{ env.ENV_SUFFIX }} \
            -n ${{ inputs.namespace }} --timeout=120s || true

      - name: Display pod logs on failure
        if: failure()
        run: kubectl logs -l app=${{ matrix.service }}${{ env.ENV_SUFFIX }} -n ${{ inputs.namespace }} --tail=50 || true

  verify-deployment:
    needs: deploy-services
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Connect to Twingate
        uses: twingate/github-action@v1
        with:
          service-key: ${{ secrets.TWINGATE_SERVICE_KEY }}

      - name: Setup Kubernetes
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify deployment
        run: |
          echo "=== Deployments ==="
          kubectl get deployments,statefulsets -n ${{ inputs.namespace }}
          echo -e "\n=== Pods ==="
          kubectl get pods -n ${{ inputs.namespace }}
          echo -e "\n=== Services ==="
          kubectl get services -n ${{ inputs.namespace }}


