databaseChangeLog:
  - changeSet:
      id: 012-merge-responses-into-comments
      author: tomassirio
      changes:
        # Add parent_comment_id column to comments table for self-referential relationship
        - addColumn:
            tableName: comments
            columns:
              - column:
                  name: parent_comment_id
                  type: uuid
                  constraints:
                    nullable: true

        # Add foreign key constraint for parent_comment_id
        - addForeignKeyConstraint:
            baseTableName: comments
            baseColumnNames: parent_comment_id
            constraintName: fk_comments_parent_comment
            referencedTableName: comments
            referencedColumnNames: id
            onDelete: CASCADE

        # Migrate existing responses to comments table
        - sql:
            sql: |
              INSERT INTO comments (id, user_id, trip_id, parent_comment_id, message, reactions, timestamp)
              SELECT r.id, r.user_id, c.trip_id, r.comment_id, r.message, r.reactions, r.timestamp
              FROM responses r
              JOIN comments c ON r.comment_id = c.id;

        # Drop the responses table as it's no longer needed
        - dropTable:
            tableName: responses

      rollback:
        # Recreate responses table
        - createTable:
            tableName: responses
            columns:
              - column:
                  name: id
                  type: uuid
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: user_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: comment_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: message
                  type: text
                  constraints:
                    nullable: false
              - column:
                  name: reactions
                  type: jsonb
              - column:
                  name: timestamp
                  type: timestamp
                  constraints:
                    nullable: false

        # Migrate replies back to responses table
        - sql:
            sql: |
              INSERT INTO responses (id, user_id, comment_id, message, reactions, timestamp)
              SELECT id, user_id, parent_comment_id, message, reactions, timestamp
              FROM comments
              WHERE parent_comment_id IS NOT NULL;

        # Delete replies from comments table
        - delete:
            tableName: comments
            where: parent_comment_id IS NOT NULL

        # Remove parent_comment_id column
        - dropForeignKeyConstraint:
            baseTableName: comments
            constraintName: fk_comments_parent_comment

        - dropColumn:
            tableName: comments
            columnName: parent_comment_id

