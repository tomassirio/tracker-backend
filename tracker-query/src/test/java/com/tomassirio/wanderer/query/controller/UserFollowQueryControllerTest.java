package com.tomassirio.wanderer.query.controller;

import static com.tomassirio.wanderer.commons.utils.BaseTestEntityFactory.USER_ID;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.tomassirio.wanderer.commons.dto.UserFollowResponse;
import com.tomassirio.wanderer.commons.exception.GlobalExceptionHandler;
import com.tomassirio.wanderer.commons.utils.MockMvcTestUtils;
import com.tomassirio.wanderer.query.service.UserFollowService;
import java.time.Instant;
import java.util.Collections;
import java.util.List;
import java.util.UUID;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.web.servlet.MockMvc;

@ExtendWith(MockitoExtension.class)
class UserFollowQueryControllerTest {

    private static final String MY_FOLLOWING_URL = "/api/1/users/me/following";
    private static final String MY_FOLLOWERS_URL = "/api/1/users/me/followers";
    private static final String USER_FOLLOWING_URL = "/api/1/users/{userId}/following";
    private static final String USER_FOLLOWERS_URL = "/api/1/users/{userId}/followers";

    private MockMvc mockMvc;

    @Mock private UserFollowService userFollowService;

    @InjectMocks private UserFollowQueryController userFollowQueryController;

    @BeforeEach
    void setUp() {
        mockMvc =
                MockMvcTestUtils.buildMockMvcWithCurrentUserResolver(
                        userFollowQueryController, new GlobalExceptionHandler());
    }

    // ============ GET MY FOLLOWING TESTS ============

    @Test
    void getMyFollowing_whenUserHasFollowing_shouldReturnFollowingList() throws Exception {
        // Given
        UUID followedUserId1 = UUID.randomUUID();
        UUID followedUserId2 = UUID.randomUUID();
        UUID followId1 = UUID.randomUUID();
        UUID followId2 = UUID.randomUUID();
        Instant now = Instant.now();

        UserFollowResponse follow1 =
                new UserFollowResponse(followId1, USER_ID, followedUserId1, now);
        UserFollowResponse follow2 =
                new UserFollowResponse(followId2, USER_ID, followedUserId2, now);

        when(userFollowService.getFollowing(USER_ID)).thenReturn(List.of(follow1, follow2));

        // When & Then
        mockMvc.perform(get(MY_FOLLOWING_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(2))
                .andExpect(jsonPath("$[0].id").value(followId1.toString()))
                .andExpect(jsonPath("$[0].followerId").value(USER_ID.toString()))
                .andExpect(jsonPath("$[0].followedId").value(followedUserId1.toString()))
                .andExpect(jsonPath("$[1].id").value(followId2.toString()))
                .andExpect(jsonPath("$[1].followerId").value(USER_ID.toString()))
                .andExpect(jsonPath("$[1].followedId").value(followedUserId2.toString()));

        verify(userFollowService).getFollowing(USER_ID);
    }

    @Test
    void getMyFollowing_whenUserHasNoFollowing_shouldReturnEmptyList() throws Exception {
        // Given
        when(userFollowService.getFollowing(USER_ID)).thenReturn(Collections.emptyList());

        // When & Then
        mockMvc.perform(get(MY_FOLLOWING_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(0));

        verify(userFollowService).getFollowing(USER_ID);
    }

    @Test
    void getMyFollowing_whenUserFollowsOneUser_shouldReturnSingleFollow() throws Exception {
        // Given
        UUID followedUserId = UUID.randomUUID();
        UUID followId = UUID.randomUUID();
        Instant now = Instant.now();

        UserFollowResponse follow = new UserFollowResponse(followId, USER_ID, followedUserId, now);

        when(userFollowService.getFollowing(USER_ID)).thenReturn(List.of(follow));

        // When & Then
        mockMvc.perform(get(MY_FOLLOWING_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].id").value(followId.toString()))
                .andExpect(jsonPath("$[0].followerId").value(USER_ID.toString()))
                .andExpect(jsonPath("$[0].followedId").value(followedUserId.toString()))
                .andExpect(jsonPath("$[0].createdAt").exists());

        verify(userFollowService).getFollowing(USER_ID);
    }

    // ============ GET MY FOLLOWERS TESTS ============

    @Test
    void getMyFollowers_whenUserHasFollowers_shouldReturnFollowersList() throws Exception {
        // Given
        UUID followerUserId1 = UUID.randomUUID();
        UUID followerUserId2 = UUID.randomUUID();
        UUID followId1 = UUID.randomUUID();
        UUID followId2 = UUID.randomUUID();
        Instant now = Instant.now();

        UserFollowResponse follow1 =
                new UserFollowResponse(followId1, followerUserId1, USER_ID, now);
        UserFollowResponse follow2 =
                new UserFollowResponse(followId2, followerUserId2, USER_ID, now);

        when(userFollowService.getFollowers(USER_ID)).thenReturn(List.of(follow1, follow2));

        // When & Then
        mockMvc.perform(get(MY_FOLLOWERS_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(2))
                .andExpect(jsonPath("$[0].id").value(followId1.toString()))
                .andExpect(jsonPath("$[0].followerId").value(followerUserId1.toString()))
                .andExpect(jsonPath("$[0].followedId").value(USER_ID.toString()))
                .andExpect(jsonPath("$[1].id").value(followId2.toString()))
                .andExpect(jsonPath("$[1].followerId").value(followerUserId2.toString()))
                .andExpect(jsonPath("$[1].followedId").value(USER_ID.toString()));

        verify(userFollowService).getFollowers(USER_ID);
    }

    @Test
    void getMyFollowers_whenUserHasNoFollowers_shouldReturnEmptyList() throws Exception {
        // Given
        when(userFollowService.getFollowers(USER_ID)).thenReturn(Collections.emptyList());

        // When & Then
        mockMvc.perform(get(MY_FOLLOWERS_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(0));

        verify(userFollowService).getFollowers(USER_ID);
    }

    @Test
    void getMyFollowers_whenUserHasOneFollower_shouldReturnSingleFollower() throws Exception {
        // Given
        UUID followerUserId = UUID.randomUUID();
        UUID followId = UUID.randomUUID();
        Instant now = Instant.now();

        UserFollowResponse follow = new UserFollowResponse(followId, followerUserId, USER_ID, now);

        when(userFollowService.getFollowers(USER_ID)).thenReturn(List.of(follow));

        // When & Then
        mockMvc.perform(get(MY_FOLLOWERS_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].id").value(followId.toString()))
                .andExpect(jsonPath("$[0].followerId").value(followerUserId.toString()))
                .andExpect(jsonPath("$[0].followedId").value(USER_ID.toString()))
                .andExpect(jsonPath("$[0].createdAt").exists());

        verify(userFollowService).getFollowers(USER_ID);
    }

    // ============ GET FOLLOWING BY USER ID TESTS ============

    @Test
    void getFollowingByUserId_whenUserHasFollowing_shouldReturnFollowingList() throws Exception {
        // Given
        UUID targetUserId = UUID.randomUUID();
        UUID followedUserId1 = UUID.randomUUID();
        UUID followedUserId2 = UUID.randomUUID();
        UUID followId1 = UUID.randomUUID();
        UUID followId2 = UUID.randomUUID();
        Instant now = Instant.now();

        UserFollowResponse follow1 =
                new UserFollowResponse(followId1, targetUserId, followedUserId1, now);
        UserFollowResponse follow2 =
                new UserFollowResponse(followId2, targetUserId, followedUserId2, now);

        when(userFollowService.getFollowing(targetUserId)).thenReturn(List.of(follow1, follow2));

        // When & Then
        mockMvc.perform(get(USER_FOLLOWING_URL, targetUserId))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(2))
                .andExpect(jsonPath("$[0].id").value(followId1.toString()))
                .andExpect(jsonPath("$[0].followerId").value(targetUserId.toString()))
                .andExpect(jsonPath("$[0].followedId").value(followedUserId1.toString()))
                .andExpect(jsonPath("$[1].id").value(followId2.toString()))
                .andExpect(jsonPath("$[1].followerId").value(targetUserId.toString()))
                .andExpect(jsonPath("$[1].followedId").value(followedUserId2.toString()));

        verify(userFollowService).getFollowing(targetUserId);
    }

    @Test
    void getFollowingByUserId_whenUserHasNoFollowing_shouldReturnEmptyList() throws Exception {
        // Given
        UUID targetUserId = UUID.randomUUID();

        when(userFollowService.getFollowing(targetUserId)).thenReturn(Collections.emptyList());

        // When & Then
        mockMvc.perform(get(USER_FOLLOWING_URL, targetUserId))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(0));

        verify(userFollowService).getFollowing(targetUserId);
    }

    // ============ GET FOLLOWERS BY USER ID TESTS ============

    @Test
    void getFollowersByUserId_whenUserHasFollowers_shouldReturnFollowersList() throws Exception {
        // Given
        UUID targetUserId = UUID.randomUUID();
        UUID followerUserId1 = UUID.randomUUID();
        UUID followerUserId2 = UUID.randomUUID();
        UUID followId1 = UUID.randomUUID();
        UUID followId2 = UUID.randomUUID();
        Instant now = Instant.now();

        UserFollowResponse follow1 =
                new UserFollowResponse(followId1, followerUserId1, targetUserId, now);
        UserFollowResponse follow2 =
                new UserFollowResponse(followId2, followerUserId2, targetUserId, now);

        when(userFollowService.getFollowers(targetUserId)).thenReturn(List.of(follow1, follow2));

        // When & Then
        mockMvc.perform(get(USER_FOLLOWERS_URL, targetUserId))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(2))
                .andExpect(jsonPath("$[0].id").value(followId1.toString()))
                .andExpect(jsonPath("$[0].followerId").value(followerUserId1.toString()))
                .andExpect(jsonPath("$[0].followedId").value(targetUserId.toString()))
                .andExpect(jsonPath("$[1].id").value(followId2.toString()))
                .andExpect(jsonPath("$[1].followerId").value(followerUserId2.toString()))
                .andExpect(jsonPath("$[1].followedId").value(targetUserId.toString()));

        verify(userFollowService).getFollowers(targetUserId);
    }

    @Test
    void getFollowersByUserId_whenUserHasNoFollowers_shouldReturnEmptyList() throws Exception {
        // Given
        UUID targetUserId = UUID.randomUUID();

        when(userFollowService.getFollowers(targetUserId)).thenReturn(Collections.emptyList());

        // When & Then
        mockMvc.perform(get(USER_FOLLOWERS_URL, targetUserId))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(0));

        verify(userFollowService).getFollowers(targetUserId);
    }

    // ============ ADDITIONAL TESTS ============

    @Test
    void getMyFollowing_shouldReturnFollowsWithCreatedAtTimestamp() throws Exception {
        // Given
        UUID followedUserId = UUID.randomUUID();
        UUID followId = UUID.randomUUID();
        Instant createdAt = Instant.parse("2025-11-12T10:00:00Z");

        UserFollowResponse follow =
                new UserFollowResponse(followId, USER_ID, followedUserId, createdAt);

        when(userFollowService.getFollowing(USER_ID)).thenReturn(List.of(follow));

        // When & Then
        mockMvc.perform(get(MY_FOLLOWING_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$[0].createdAt").exists())
                .andExpect(jsonPath("$[0].createdAt").isNotEmpty());

        verify(userFollowService).getFollowing(USER_ID);
    }

    @Test
    void getMyFollowers_shouldReturnFollowsWithCreatedAtTimestamp() throws Exception {
        // Given
        UUID followerUserId = UUID.randomUUID();
        UUID followId = UUID.randomUUID();
        Instant createdAt = Instant.parse("2025-11-12T10:00:00Z");

        UserFollowResponse follow =
                new UserFollowResponse(followId, followerUserId, USER_ID, createdAt);

        when(userFollowService.getFollowers(USER_ID)).thenReturn(List.of(follow));

        // When & Then
        mockMvc.perform(get(MY_FOLLOWERS_URL))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$[0].createdAt").exists())
                .andExpect(jsonPath("$[0].createdAt").isNotEmpty());

        verify(userFollowService).getFollowers(USER_ID);
    }
}
